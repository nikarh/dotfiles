x-defaults: &defaults
  logging:
    driver: "json-file"
    options:
      max-size: ${LOG_MAX_SIZE:-200k}
      max-file: ${LOG_MAX_FILE:-5}
  networks:
    - affine_net

x-service-defaults: &service-defaults
  <<: *defaults
  restart: unless-stopped

x-hardened: &hardened
  read_only: true
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - NET_RAW

volumes:
  affine-data: # 1000:1000
  affine-config: # 1000:1000
  affine-db-data:

x-affine-env: &affine-env
  REDIS_SERVER_HOST: affine-redis
  REDIS_SERVER_PASSWORD: ${AFFINE_REDIS_PASSWORD}
  DATABASE_URL: postgresql://affine:${AFFINE_DB_PASSWORD}@affine-postgres:5432/affine
  AFFINE_INDEXER_ENABLED: false
  AFFINE_SERVER_EXTERNAL_URL: https://affine.files.home.arhipov.net

services:
  affine:
    image: ghcr.io/toeverything/affine:stable
    container_name: affine
    <<: [*defaults, *hardened]
    user: "1000:1000"
    depends_on:
      affine-redis:
        condition: service_started
      affine-postgres:
        condition: service_started
      affine-migration:
        condition: service_completed_successfully
      init-volumes:
        condition: service_completed_successfully
    volumes:
      - affine-data:/home/node/.affine/storage
      - affine-config:/home/node/.affine/config
    tmpfs:
      - /app/src:noexec,size=100M,uid=1000,gid=1000
    environment:
      <<: *affine-env
    networks:
      - affine_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.affine.loadbalancer.server.port=3010"
      - "traefik.http.routers.affine.rule=Host(`affine.${DOMAIN}`)"
      - "traefik.http.routers.affine.entrypoints=https"
      - "traefik.docker.network=affine_net"
    deploy:
      resources:
        limits:
          memory: 5G
        reservations:
          memory: 1G
  affine-migration:
    image: ghcr.io/toeverything/affine:stable
    container_name: affine-db-migration-job
    <<: [*defaults, *hardened]
    user: "1000:1000"
    volumes:
      - affine-config:/home/node/.affine/config
    tmpfs:
      - /tmp:noexec,size=10M
    command: ["sh", "-c", "node ./scripts/self-host-predeploy.js"]
    environment:
      <<: *affine-env
      YARN_CACHE_FOLDER: /tmp/.yarn-cache
      YARN_PREFIX: /tmp/.yarn-global
    networks:
      - affine_net
    depends_on:
      affine-postgres:
        condition: service_started
      affine-redis:
        condition: service_started
      init-volumes:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 100M
  affine-redis:
    image: valkey/valkey:alpine
    container_name: affine-redis
    <<: [*service-defaults, *hardened]
    user: "999:999"
    command: >
      --requirepass ${AFFINE_REDIS_PASSWORD} --save "" --appendonly no
    tmpfs:
      - /data:noexec,size=10M
    deploy:
      resources:
        limits:
          memory: 200M
        reservations:
          memory: 20M
  affine-postgres:
    image: pgvector/pgvector:pg16
    container_name: affine-postgres
    <<: [*service-defaults, *hardened]
    user: "999:999"
    volumes:
      - affine-db-data:/var/lib/postgresql/data
    tmpfs:
      - /tmp:noexec,size=1G # Large queries
      - /var/run/postgresql:noexec,size=1M # Socket
    environment:
      POSTGRES_USER: affine
      POSTGRES_PASSWORD: ${AFFINE_DB_PASSWORD}
      POSTGRES_DB: affine
      POSTGRES_INITDB_ARGS: "--data-checksums"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 100M

networks:
  affine_net:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.20.0.0/28
